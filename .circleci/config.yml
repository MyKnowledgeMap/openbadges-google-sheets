version: 2

defaults: &defaults
  working_directory: /home/circleci/ob-forms
  docker:
    - image: 'circleci/node:8.9.4'

jobs:
  install_dependencies:
    <<: *defaults
    steps:
      - checkout
      - restore_cache:
          keys:
            - 'dependencies-v1-{{ checksum "package.json" }}'
            - 'dependencies-v1-'
      - run:
          name: Install dependencies
          command: 'npm install'
      - save_cache:
          key: 'dependencies-v1-{{ checksum "package.json" }}'
          paths:
            - node_modules

  test:
    <<: *defaults
    environment:
      JEST_JUNIT_OUTPUT: 'reports/jest/jest-results.xml'
    steps:
      - checkout
      - restore_cache:
          keys:
            - 'dependencies-v1-{{ checksum "package.json" }}'
      - run: 'npm install'
      - run: 
          name: 'Create reports folder(s)'
          command: 'mkdir -p reports/{jest,tslint}'
      - run:
          name: Run linter
          command: 'npm run lint:ci'
      - run:
          name: Run tests
          command: 'npm run test:ci'
      - store_test_results:
          path: 'reports'
      - store_artifacts:
          path: 'reports'

  build:
    <<: *defaults
    steps:
      - restore_cache:
          keys:
            - 'dependencies-v1-{{ checksum "package.json" }}'
      - run: 'npm install'
      - run: 
          name: 'Run build'
          command: 'npm run build'
      - store_artifacts:
          path: 'dist' 
      - persist_to_workspace: 
          root: /home/circleci
          paths:
            - ob-forms

  deploy:
    <<: *defaults
    parallelism: 1
    steps:
      - attach_workspace:
          at: /home/circleci
      - run: 'node ./scripts/pre-package'
      - run: 'node ./scripts/package'
      - run: 'node ./scripts/deploy'
      - store_artifacts:
          path: 'dist'

workflows:
  version: 2
  ob-forms:
    jobs:
      - install_dependencies
      - test:
          requires:
            - 'install_dependencies'
      - build:
          requires:
            - 'install_dependencies'
      - deploy:
          requires:
            - 'test'
            - 'build'
          filters:
            branches:
              only:
                - 'master'
                - 'circleci-workflow'